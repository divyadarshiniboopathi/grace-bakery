<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta name="description" content="Bakery Recipe Manager - Manage and scale your bakery recipes">
  <meta name="theme-color" content="#8B5A3C">
  <link rel="manifest" href="manifest.json">
  <link rel="icon" type="image/png" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>ü•ê</text></svg>">
  <title>Bakery Recipe Manager</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Georgia','Times New Roman',serif;background:linear-gradient(rgba(0,0,0,.4),rgba(0,0,0,.4)),url('https://images.unsplash.com/photo-1509440159596-0249088772ff?w=1600') center/cover no-repeat fixed;min-height:100vh;padding:20px}
    .container{max-width:900px;margin:0 auto;background:rgba(255,255,255,.98);border-radius:15px;box-shadow:0 20px 60px rgba(0,0,0,.5);overflow:hidden}
    .header{background:linear-gradient(135deg,#8B5A3C 0%,#D2691E 100%);color:#fff;padding:40px 30px;text-align:center;position:relative;overflow:hidden}
    .header::before{content:'';position:absolute;inset:0;background:url('data:image/svg+xml,<svg width="100" height="100" xmlns="http://www.w3.org/2000/svg"><text x="10" y="50" font-size="40" opacity="0.1">ü•ñ</text></svg>');opacity:.3}
    .header h1{font-size:2.8em;margin-bottom:10px;text-shadow:3px 3px 6px rgba(0,0,0,.4);font-weight:bold;letter-spacing:2px;position:relative;z-index:1}
    .header p{font-size:1.2em;opacity:.95;font-style:italic;position:relative;z-index:1}
    .user-info{position:absolute;top:20px;right:20px;background:rgba(255,255,255,.2);padding:10px 20px;border-radius:25px;font-size:.9em;z-index:2}
    .user-info button{background:rgba(255,255,255,.3);border:none;color:#fff;padding:5px 15px;border-radius:15px;cursor:pointer;margin-left:10px}
    .user-info button:hover{background:rgba(255,255,255,.4)}
    .nav{display:flex;background:#F5E6D3;border-bottom:3px solid #D2691E}
    .nav-btn{flex:1;padding:20px;background:none;border:none;cursor:pointer;font-size:1.1em;font-weight:600;color:#5C4033;transition:.3s;position:relative}
    .nav-btn:hover{background:rgba(139,90,60,.15);color:#8B5A3C}
    .nav-btn.active{color:#8B5A3C;background:rgba(210,105,30,.1)}
    .nav-btn.active::after{content:'';position:absolute;left:0;right:0;bottom:0;height:4px;background:#D2691E}
    .nav-btn:disabled{opacity:.5;cursor:not-allowed}
    .content{padding:40px}
    .page{display:none}
    .page.active{display:block;animation:fade .25s}@keyframes fade{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
    .form-group{margin-bottom:25px;position:relative}
    label{display:block;margin-bottom:8px;color:#5C4033;font-weight:600}
    input,select,textarea{width:100%;padding:12px 15px;border:2px solid #D2B48C;border-radius:8px;font-size:1em;transition:.2s}
    input:focus,select:focus,textarea:focus{outline:none;border-color:#8B5A3C;box-shadow:0 0 0 3px rgba(139,90,60,.1)}
    textarea{resize:vertical;min-height:120px}
    .autocomplete-container{position:relative}
    .autocomplete-suggestions{position:absolute;top:100%;left:0;right:0;background:#fff;border:2px solid #8B5A3C;border-top:none;border-radius:0 0 8px 8px;max-height:200px;overflow:auto;z-index:1000;box-shadow:0 4px 10px rgba(0,0,0,.2)}
    .autocomplete-suggestion{padding:12px 15px;cursor:pointer;border-bottom:1px solid #f0f0f0}
    .autocomplete-suggestion:hover{background:#FFF8F0}
    .ingredient-input{display:flex;gap:10px;margin-bottom:10px}
    .ingredient-input input{flex:1}.ingredient-input input:first-child{flex:2}
    .btn{padding:14px 32px;border:none;border-radius:8px;font-weight:600;cursor:pointer;transition:.2s;margin-right:10px;margin-top:10px}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .btn-primary{background:linear-gradient(135deg,#D2691E 0%,#8B5A3C 100%);color:#fff;box-shadow:0 4px 15px rgba(139,90,60,.4)}
    .btn-primary:hover:not(:disabled){transform:translateY(-2px);box-shadow:0 6px 20px rgba(139,90,60,.6)}
    .btn-secondary{background:#F5E6D3;color:#5C4033;border:2px solid #D2B48C}
    .btn-secondary:hover{background:#E8D5C4}
    .btn-danger{background:#dc3545;color:#fff}.btn-danger:hover{background:#c82333}
    .recipe-card{background:#fff;border:2px solid #e0e0e0;border-radius:15px;padding:25px;margin-bottom:20px;transition:.2s}
    .recipe-card:hover{box-shadow:0 5px 20px rgba(0,0,0,.1);transform:translateY(-2px)}
    .recipe-card h3{color:#8B5A3C;margin-bottom:15px;font-size:1.6em}
    .recipe-details{color:#5C4033;line-height:1.8}
    .ingredient-list{margin-top:10px;padding-left:20px}
    .no-recipes{text-align:center;padding:60px 20px;color:#999;font-size:1.2em}
    .success-message{background:#d4edda;color:#155724;padding:15px;border-radius:10px;margin-bottom:20px;border:1px solid #c3e6cb}
    .error-message{background:#f8d7da;color:#721c24;padding:15px;border-radius:10px;margin-bottom:20px;border:1px solid #f5c6cb}
    .ingredients-container{background:#FFF8F0;padding:20px;border-radius:10px;margin-bottom:20px;border:2px solid #F5E6D3}
    #ingredientsList{margin-bottom:15px}
    .auth-container{max-width:450px;margin:100px auto;background:#fff;padding:40px;border-radius:15px;box-shadow:0 10px 40px rgba(0,0,0,.3)}
    .auth-container h2{color:#8B5A3C;text-align:center;margin-bottom:30px;font-size:2em}
    .auth-tabs{display:flex;margin-bottom:30px;border-bottom:2px solid #F5E6D3}
    .auth-tab{flex:1;padding:15px;background:none;border:none;cursor:pointer;font-size:1.1em;font-weight:600;color:#999}
    .auth-tab.active{color:#8B5A3C;border-bottom:3px solid #D2691E;margin-bottom:-2px}
    .user-list{margin-top:20px}
    .user-item{background:#FFF8F0;padding:15px;border-radius:8px;margin-bottom:10px;display:flex;justify-content:space-between;align-items:center}
    .user-item-actions select{padding:8px 12px;border:2px solid #D2B48C;border-radius:5px;margin-right:10px}
    .role-badge{display:inline-block;padding:4px 12px;border-radius:12px;font-size:.85em;font-weight:600;margin-left:10px}
    .role-badge.admin{background:#8B5A3C;color:#fff}.role-badge.staff{background:#D2691E;color:#fff}
  </style>
</head>
<body>

  <!-- AUTH -->
  <div id="authContainer" class="auth-container" style="display:none;">
    <h2>Grace Bakery - Recipe Manager</h2>

    <div class="auth-tabs">
      <button class="auth-tab active" onclick="switchAuthTab('login')">Login</button>
      <button class="auth-tab" onclick="switchAuthTab('signup')">Sign Up</button>
    </div>

    <div id="authMessage"></div>

    <!-- Login -->
    <div id="loginForm">
      <div class="form-group">
        <label>Phone</label>
        <input type="tel" id="loginPhone" placeholder="e.g., 9876543210" />
      </div>
      <div class="form-group">
        <label>Password</label>
        <input type="password" id="loginPassword" placeholder="Enter password" />
      </div>
      <button class="btn btn-primary" style="width:100%;" onclick="handleLogin()">Login</button>
    </div>

    <!-- Signup -->
    <div id="signupForm" style="display:none;">
      <div class="form-group">
        <label>Phone</label>
        <input type="tel" id="signupPhone" placeholder="e.g., 9876543210" />
      </div>
      <div class="form-group">
        <label>Name (optional)</label>
        <input type="text" id="signupName" placeholder="Your name" />
      </div>
      <div class="form-group">
        <label>Password</label>
        <input type="password" id="signupPassword" placeholder="Min 6 characters" />
      </div>
      <div class="form-group">
        <label>Confirm Password</label>
        <input type="password" id="signupPasswordConfirm" placeholder="Re-enter password" />
      </div>
      <button class="btn btn-primary" style="width:100%;" onclick="handleSignup()">Sign Up</button>
    </div>
  </div>

  <!-- APP -->
  <div id="appContainer" class="container" style="display:none;">
    <div class="header">
      <div class="user-info">
        <span id="userPhone"></span>
        <span id="userRole" class="role-badge"></span>
        <button onclick="handleLogout()">Logout</button>
      </div>
      <h1>Grace Bakery - Recipe Manager</h1>
      <p>Manage your recipes with grace</p>
    </div>

    <div class="nav">
      <button id="navAdd" class="nav-btn active" onclick="showPage('add')">Add Recipe</button>
      <button id="navRetrieve" class="nav-btn" onclick="showPage('retrieve')">Scale Recipe</button>
      <button id="navView" class="nav-btn" onclick="showPage('view')">View All</button>
      <button id="navAdmin" class="nav-btn" style="display:none;" onclick="showPage('admin')">Admin</button>
    </div>

    <div class="content">
      <!-- Add Recipe -->
      <div id="addPage" class="page active">
        <h2 style="margin-bottom:30px;color:#333;">Add New Recipe</h2>
        <div id="addMessage"></div>

        <div class="form-group autocomplete-container">
          <label>Item Name</label>
          <input type="text" id="itemName" placeholder="e.g., Potato Chips" autocomplete="off"/>
          <div id="itemNameSuggestions" class="autocomplete-suggestions" style="display:none;"></div>
        </div>

        <div class="form-group">
          <label>Quantity</label>
          <div style="display:flex;gap:10px;">
            <input type="number" id="itemQuantity" placeholder="e.g., 10" style="flex:2;" step="0.01"/>
            <select id="itemUnit" style="flex:1;">
              <option value="kg">kg</option><option value="g">g</option><option value="L">L</option>
              <option value="ml">ml</option><option value="lbs">lbs</option><option value="oz">oz</option>
              <option value="cups">cups</option><option value="tbsp">tbsp</option><option value="tsp">tsp</option>
              <option value="pieces">pieces</option>
            </select>
          </div>
        </div>

        <div class="form-group">
          <label>Ingredients</label>
          <div class="ingredients-container">
            <div id="ingredientsList">
              <div class="ingredient-input">
                <div style="flex:2;position:relative" class="autocomplete-container">
                  <input type="text" placeholder="Ingredient name (e.g., Oil)" class="ing-name" autocomplete="off"/>
                  <div class="ing-suggestions autocomplete-suggestions" style="display:none;"></div>
                </div>
                <input type="number" placeholder="Qty" class="ing-qty" style="flex:1;" step="0.01"/>
                <select class="ing-unit" style="flex:1;">
                  <option value="kg">kg</option><option value="g">g</option><option value="L">L</option>
                  <option value="ml">ml</option><option value="lbs">lbs</option><option value="oz">oz</option>
                  <option value="cups">cups</option><option value="tbsp">tbsp</option><option value="tsp">tsp</option>
                  <option value="pieces">pieces</option>
                </select>
              </div>
            </div>
            <button class="btn btn-secondary" onclick="addIngredientField()">+ Add Ingredient</button>
          </div>
        </div>

        <button id="saveBtn" class="btn btn-primary" onclick="saveRecipe()">Save Recipe</button>
      </div>

      <!-- Scale -->
      <div id="retrievePage" class="page">
        <h2 style="margin-bottom:30px;color:#333;">Scale Recipe</h2>
        <div id="retrieveMessage"></div>

        <div class="form-group autocomplete-container">
          <label>Item Name</label>
          <input type="text" id="retrieveItemName" placeholder="e.g., Potato Chips" autocomplete="off"/>
          <div id="retrieveItemSuggestions" class="autocomplete-suggestions" style="display:none;"></div>
        </div>

        <div class="form-group">
          <label>Desired Quantity</label>
          <div style="display:flex;gap:10px;">
            <input type="number" id="retrieveQuantity" placeholder="e.g., 3" style="flex:2;" step="0.01"/>
            <select id="retrieveUnit" style="flex:1;">
              <option value="kg">kg</option><option value="g">g</option><option value="L">L</option>
              <option value="ml">ml</option><option value="lbs">lbs</option><option value="oz">oz</option>
              <option value="cups">cups</option><option value="tbsp">tbsp</option><option value="tsp">tsp</option>
              <option value="pieces">pieces</option>
            </select>
          </div>
        </div>

        <button class="btn btn-primary" onclick="scaleRecipe()">Calculate Scaled Recipe</button>
        <div id="scaledRecipeResult"></div>
      </div>

      <!-- View -->
      <div id="viewPage" class="page">
        <h2 style="margin-bottom:30px;color:#333;">All Recipes</h2>
        <div id="recipesList"></div>
      </div>

      <!-- Admin -->
      <div id="adminPage" class="page">
        <h2 style="margin-bottom:30px;color:#333;">Admin Panel</h2>
        <div id="adminMessage"></div>

        <div style="background:#FFF8F0;padding:25px;border-radius:10px;margin-bottom:30px;">
          <h3 style="color:#8B5A3C;margin-bottom:20px;">Invite New User</h3>
          <div class="form-group">
            <label>Phone Number</label>
            <input type="tel" id="invitePhone" placeholder="e.g., 9876543210"/>
          </div>
          <div class="form-group">
            <label>Assign Role</label>
            <select id="inviteRole">
              <option value="staff">Staff</option>
              <option value="admin">Admin</option>
            </select>
          </div>
          <button class="btn btn-primary" onclick="inviteUser()">Send Invitation</button>
        </div>

        <h3 style="color:#8B5A3C;margin-bottom:20px;">Manage Users</h3>
        <div id="userList" class="user-list"></div>
      </div>
    </div>
  </div>

  <script>
    // ===== CONFIG =====
    const API ='https://script.google.com/macros/s/AKfycbyHSQr1G1PkJhWjJZzYPYNahbi-2cO4CJO-yEcGjzCrNGozQM2v_0X6yArorEMjRSvbEQ/exec';
    // ===== State =====
    let currentUser = null;     // { token, role, name, phone }
    let recipes = [];
    let itemNames = new Set();
    let ingredientNames = new Set();

    // ===== Helpers =====
    const qs = s => document.querySelector(s);
    const qsa = s => Array.from(document.querySelectorAll(s));
    const val = id => document.getElementById(id).value.trim();

    async function api(body) {
        const res = await fetch(API, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(body)
        });
        const text = await res.text();
        try {
            return JSON.parse(text);
        }   catch {
            console.log("Raw response:", text);
            return { error: "Invalid JSON from server" };
        }
    }


    function msg(elId, text, type){
      const el = document.getElementById(elId);
      el.innerHTML = `<div class="${type}-message">${text}</div>`;
      setTimeout(()=> el.innerHTML = '', 3000);
    }
    function showAuth(){ qs('#authContainer').style.display='block'; qs('#appContainer').style.display='none'; }
    function showApp(){ qs('#authContainer').style.display='none'; qs('#appContainer').style.display='block'; updateUIForRole(); loadRecipes(); if(currentUser.role==='admin') loadUsers(); }

    // ===== Auth Tabs =====
    function switchAuthTab(tab){
      const login = qs('#loginForm'); const signup = qs('#signupForm');
      qsa('.auth-tab').forEach(t=>t.classList.remove('active'));
      if(tab==='login'){ login.style.display='block'; signup.style.display='none'; qsa('.auth-tab')[0].classList.add('active'); }
      else { login.style.display='none'; signup.style.display='block'; qsa('.auth-tab')[1].classList.add('active'); }
      qs('#authMessage').innerHTML='';
    }

    // ===== Auth (phone/password) =====
    function showAuthMessage(t, type){ msg('authMessage', t, type); }

    async function handleSignup(){
      const phone = val('signupPhone');
      const name  = val('signupName');
      const pw    = val('signupPassword');
      const pw2   = val('signupPasswordConfirm');
      if(!phone || !pw || !pw2) return showAuthMessage('Please fill in all fields','error');
      if(pw !== pw2) return showAuthMessage('Passwords do not match','error');
      if(pw.length < 6) return showAuthMessage('Password must be at least 6 characters','error');

      const r = await api({ action:'signup', phone, password: pw, name });
      if(r.success){ showAuthMessage('Account created! Please login.','success'); setTimeout(()=>switchAuthTab('login'), 1200); }
      else showAuthMessage(r.error || 'Signup failed','error');
    }

    async function handleLogin(){
      const phone = val('loginPhone');
      const pw    = val('loginPassword');
      if(!phone || !pw) return showAuthMessage('Please fill in all fields','error');
      const r = await api({ action:'login', phone, password: pw });
      if(r.success){
        currentUser = { token: r.token, role: r.role || 'staff', name: r.name || '', phone };
        localStorage.setItem('session', JSON.stringify(currentUser));
        showApp();
      } else showAuthMessage(r.error || 'Login failed','error');
    }

    async function handleLogout(){
      localStorage.removeItem('session');
      currentUser = null;
      showAuth();
    }

    function updateUIForRole(){
      qs('#userPhone').textContent = currentUser?.phone || '';
      const badge = qs('#userRole');
      const role = (currentUser?.role || 'staff').toLowerCase();
      badge.textContent = role.toUpperCase();
      badge.className = `role-badge ${role}`;

      const isAdmin = role==='admin';
      qs('#navAdd').disabled = !isAdmin;
      qs('#navAdd').style.opacity = isAdmin ? '1' : '0.5';
      qs('#navAdmin').style.display = isAdmin ? 'block' : 'none';
    }

    // ===== Navigation =====
    function showPage(page){
      if((currentUser?.role || 'staff')==='staff' && page==='add'){
        msg('addMessage','You do not have permission to add recipes. Contact an admin.','error'); return;
      }
      qsa('.page').forEach(p=>p.classList.remove('active'));
      qsa('.nav-btn').forEach(b=>b.classList.remove('active'));
      qs(`#${page}Page`).classList.add('active');
      qs(`#nav${page[0].toUpperCase()+page.slice(1)}`).classList.add('active');
      if(page==='view') displayAllRecipes();
      if(page==='admin') loadUsers();
    }

    // ===== Ingredients UI =====
    function addIngredientField(){
      const list = qs('#ingredientsList');
      const div = document.createElement('div');
      div.className = 'ingredient-input';
      div.innerHTML = `
        <div style="flex:2;position:relative" class="autocomplete-container">
          <input type="text" placeholder="Ingredient name" class="ing-name" autocomplete="off"/>
          <div class="ing-suggestions autocomplete-suggestions" style="display:none;"></div>
        </div>
        <input type="number" placeholder="Qty" class="ing-qty" style="flex:1;" step="0.01"/>
        <select class="ing-unit" style="flex:1;">
          <option value="kg">kg</option><option value="g">g</option><option value="L">L</option>
          <option value="ml">ml</option><option value="lbs">lbs</option><option value="oz">oz</option>
          <option value="cups">cups</option><option value="tbsp">tbsp</option><option value="tsp">tsp</option>
          <option value="pieces">pieces</option>
        </select>`;
      list.appendChild(div);
      setupIngredientAutocomplete();
    }

    // ===== Autocomplete (local) =====
    function updateAutocomplete(){
      itemNames.clear(); ingredientNames.clear();
      recipes.forEach(r=>{
        itemNames.add(r.item_name);
        (r.ingredients||[]).forEach(i=>ingredientNames.add(i.name));
      });
    }
    function setupAutocomplete(input, suggestions, dataSet){
      input.addEventListener('input', function(){
        const v = this.value.toLowerCase();
        suggestions.innerHTML=''; if(!v){ suggestions.style.display='none'; return; }
        const matches = Array.from(dataSet).filter(s=>s.toLowerCase().includes(v));
        if(!matches.length){ suggestions.style.display='none'; return; }
        matches.forEach(m=>{
          const d=document.createElement('div'); d.className='autocomplete-suggestion'; d.textContent=m;
          d.addEventListener('click', ()=>{ input.value=m; suggestions.style.display='none';});
          suggestions.appendChild(d);
        });
        suggestions.style.display='block';
      });
      input.addEventListener('blur', ()=> setTimeout(()=> suggestions.style.display='none', 200));
    }
    function initializeAutocomplete(){
      setupAutocomplete(qs('#itemName'), qs('#itemNameSuggestions'), itemNames);
      setupAutocomplete(qs('#retrieveItemName'), qs('#retrieveItemSuggestions'), itemNames);
      setupIngredientAutocomplete();
    }
    function setupIngredientAutocomplete(){
      qsa('.ing-name').forEach(input=>{
        const box = input.closest('.autocomplete-container');
        const sug = box.querySelector('.ing-suggestions');
        setupAutocomplete(input, sug, ingredientNames);
      });
    }

    // ===== Recipes =====
    async function loadRecipes(){
      try{
        const r = await api({ action:'getRecipes' });
        recipes = r.recipes || [];
        updateAutocomplete(); initializeAutocomplete();
      }catch(e){ console.error(e); msg('addMessage','Error loading recipes','error'); }
    }

    function resetAddForm(){
      qs('#itemName').value=''; qs('#itemQuantity').value='';
      qs('#itemUnit').selectedIndex=0;
      qs('#ingredientsList').innerHTML = `
        <div class="ingredient-input">
          <div style="flex:2;position:relative" class="autocomplete-container">
            <input type="text" placeholder="Ingredient name (e.g., Oil)" class="ing-name" autocomplete="off"/>
            <div class="ing-suggestions autocomplete-suggestions" style="display:none;"></div>
          </div>
          <input type="number" placeholder="Qty" class="ing-qty" style="flex:1;" step="0.01"/>
          <select class="ing-unit" style="flex:1;">
            <option value="kg">kg</option><option value="g">g</option><option value="L">L</option>
            <option value="ml">ml</option><option value="lbs">lbs</option><option value="oz">oz</option>
            <option value="cups">cups</option><option value="tbsp">tbsp</option><option value="tsp">tsp</option>
            <option value="pieces">pieces</option>
          </select>
        </div>`;
      setupIngredientAutocomplete();
    }

    async function saveRecipe(){
      if((currentUser?.role)!=='admin'){ msg('addMessage','You do not have permission','error'); return; }
      const item_name = val('itemName');
      const item_quantity = val('itemQuantity');
      const item_unit = qs('#itemUnit').value;
      const ings = qsa('#ingredientsList .ingredient-input').map(div=>({
        name: div.querySelector('.ing-name').value.trim(),
        quantity: div.querySelector('.ing-qty').value.trim(),
        unit: div.querySelector('.ing-unit').value
      })).filter(i=> i.name && i.quantity);

      if(!item_name || !item_quantity || !ings.length)
        return msg('addMessage','Please fill all fields','error');

      const btn = qs('#saveBtn'); btn.disabled=true; btn.textContent='Saving...';
      const r = await api({ action:'addRecipe', token: currentUser.token, item_name, item_quantity, item_unit, ingredients: ings });
      btn.disabled=false; btn.textContent='Save Recipe';

      if(r.success){ msg('addMessage','Recipe saved successfully!','success'); await loadRecipes(); resetAddForm(); }
      else msg('addMessage', r.error || 'Save failed', 'error');
    }

    function displayAllRecipes(){
      const container = qs('#recipesList');
      if(!recipes.length){ container.innerHTML = '<div class="no-recipes">No recipes saved yet. Add your first recipe!</div>'; return; }
      container.innerHTML = recipes.map(recipe => `
        <div class="recipe-card">
          <h3>${recipe.item_name}</h3>
          <div class="recipe-details">
            <p><strong>Quantity:</strong> ${recipe.item_quantity} ${recipe.item_unit}</p>
            <p><strong>Ingredients:</strong></p>
            <div class="ingredient-list">
              ${recipe.ingredients.map(ing=>`<p>‚Ä¢ ${ing.name}: ${ing.quantity} ${ing.unit}</p>`).join('')}
            </div>
            ${currentUser?.role==='admin' ? `<button class="btn btn-danger" onclick="deleteRecipe('${encodeURIComponent(recipe.item_name)}')">Delete</button>` : ''}
            <button class="btn btn-secondary" style="margin-left:10px" onclick="printRecipe('${encodeURIComponent(recipe.item_name)}')">Print</button>
          </div>
        </div>`).join('');
    }

    async function deleteRecipe(itemNameEnc){
      if((currentUser?.role)!=='admin') return alert('Not allowed');
      if(!confirm('Delete this recipe?')) return;
      const name = decodeURIComponent(itemNameEnc);
      const r = await api({ action:'deleteRecipe', token: currentUser.token, item_name: name });
      if(r.success){ await loadRecipes(); displayAllRecipes(); msg('addMessage','Recipe deleted','success'); }
      else alert(r.error || 'Delete failed');
    }

    // ===== Scaling & Print =====
    function scaleRecipe(){
      const itemName = val('retrieveItemName');
      const desiredQty = val('retrieveQuantity');
      const desiredUnit = qs('#retrieveUnit').value;

      if(!itemName || !desiredQty) { msg('retrieveMessage','Please fill in both fields','error'); return; }

      const recipe = recipes.find(r=> r.item_name.toLowerCase() === itemName.toLowerCase());
      if(!recipe){ msg('retrieveMessage','Recipe not found','error'); qs('#scaledRecipeResult').innerHTML=''; return; }
      if(recipe.item_unit !== desiredUnit){ msg('retrieveMessage', `Warning: Original recipe uses ${recipe.item_unit}, but you selected ${desiredUnit}. Please use matching units.`, 'error'); return; }

      const scale = parseFloat(desiredQty) / parseFloat(recipe.item_quantity);
      const html = `
        <div class="recipe-card" style="margin-top:30px;">
          <h3>${recipe.item_name}</h3>
          <div class="recipe-details">
            <p><strong>Original Quantity:</strong> ${recipe.item_quantity} ${recipe.item_unit}</p>
            <p><strong>Scaled Quantity:</strong> ${desiredQty} ${desiredUnit}</p>
            <p><strong>Scale Factor:</strong> ${scale.toFixed(2)}x</p>
            <p><strong>Scaled Ingredients:</strong></p>
            <div class="ingredient-list">
              ${recipe.ingredients.map(i=>`<p>‚Ä¢ ${i.name}: ${(parseFloat(i.quantity)*scale).toFixed(2)} ${i.unit}</p>`).join('')}
            </div>
            <button class="btn btn-primary" style="margin-top:20px" onclick="window.print()">Print Recipe</button>
          </div>
        </div>`;
      qs('#scaledRecipeResult').innerHTML = html;
      msg('retrieveMessage','Recipe scaled successfully!','success');
    }

    function printRecipe(nameEnc){
      const name = decodeURIComponent(nameEnc);
      const r = recipes.find(x=> x.item_name === name);
      const w = window.open('', '_blank');
      w.document.write(`
        <html><head><title>${r.item_name}</title>
        <style>body{font-family:Georgia,serif;padding:24px}h2{color:#8B5A3C}ul{padding-left:18px}</style>
        </head><body>
          <h2>${r.item_name}</h2>
          <p><strong>Quantity:</strong> ${r.item_quantity} ${r.item_unit}</p>
          <p><strong>Ingredients:</strong></p>
          <ul>${r.ingredients.map(i=>`<li>${i.name}: ${i.quantity} ${i.unit}</li>`).join('')}</ul>
        </body></html>`);
      w.document.close(); w.focus(); w.print(); w.close();
    }

    // ===== Admin (Users) =====
    async function loadUsers(){
      if((currentUser?.role)!=='admin') return;
      const r = await api({ action:'listUsers', token: currentUser.token });
      if(r.error) return msg('adminMessage', r.error, 'error');
      displayUsers(r.users || []);
    }
    function displayUsers(users){
      const c = qs('#userList');
      if(!users.length){ c.innerHTML = '<p style="text-align:center;color:#999;">No users found</p>'; return; }
      c.innerHTML = users.map(u=> `
        <div class="user-item">
          <div><strong>${u.phone}</strong> <span class="role-badge ${u.role}">${u.role.toUpperCase()}</span></div>
          <div class="user-item-actions">
            <select onchange="changeUserRole('${u.phone}', this.value)">
              <option value="staff" ${u.role==='staff'?'selected':''}>Staff</option>
              <option value="admin" ${u.role==='admin'?'selected':''}>Admin</option>
            </select>
            <button class="btn btn-danger" onclick="removeUser('${u.phone}')">Remove</button>
          </div>
        </div>`).join('');
    }
    async function changeUserRole(phone, role){
      if((currentUser?.role)!=='admin') return;
      const r = await api({ action:'changeRole', token: currentUser.token, phone, role });
      if(r.success) msg('adminMessage','User role updated','success'); else msg('adminMessage', r.error || 'Error updating role','error');
    }
    async function removeUser(phone){
      if((currentUser?.role)!=='admin') return;
      if(!confirm('Remove this user?')) return;
      const r = await api({ action:'removeUser', token: currentUser.token, phone });
      if(r.success){ msg('adminMessage','User removed','success'); loadUsers(); } else msg('adminMessage', r.error || 'Error removing user','error');
    }
    async function inviteUser(){
      if((currentUser?.role)!=='admin') return msg('adminMessage','You do not have permission','error');
      const phone = val('invitePhone'); const role = qs('#inviteRole').value;
      if(!phone) return msg('adminMessage','Please enter a phone','error');
      // For a simple flow: "inviting" means creating or updating the user row with given role (no password yet).
      const r = await api({ action:'inviteUser', token: currentUser.token, phone, role });
      if(r.ok || r.success){ msg('adminMessage', `Invitation recorded for ${phone}`,'success'); qs('#invitePhone').value=''; loadUsers(); }
      else msg('adminMessage', r.error || 'Error inviting','error');
    }

    // ===== Boot & SW =====
    window.addEventListener('load', async ()=>{
      const saved = localStorage.getItem('session');
      if(saved){ try{ currentUser = JSON.parse(saved); }catch{} }
      if(currentUser?.token) showApp(); else showAuth();

      if('serviceWorker' in navigator){
        try{ await navigator.serviceWorker.register('sw.js'); }catch(e){ console.log('SW failed', e); }
      }
    });
  </script>
</body>
</html>
